<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë²•ë¥  ë¬¸ì„œ í•™ìŠµ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 40px; background: #f3f4f6; color: #1f2937; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #111827; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
        
        .section { margin-bottom: 30px; }
        .label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; font-size: 1.1rem; }
        .sub-label { display: block; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; }
        
        .drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.2s; background: #f9fafb; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        
        .ai-result-box { padding: 15px; margin-bottom: 10px; border-radius: 6px; display: none; border-left-width: 5px; border-left-style: solid; }
        .ai-title { font-weight: bold; margin-bottom: 5px; display: block; font-size: 0.95rem;}
        .ai-content { white-space: pre-wrap; font-size: 0.9rem; color: #334155; font-family: monospace; }

        .box-blue { background-color: #f0f9ff; border-left-color: #0ea5e9; }
        .box-gray { background-color: #f1f5f9; border-left-color: #64748b; }
        .box-purple { background-color: #f5f3ff; border-left-color: #8b5cf6; }
        
        select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; margin-bottom: 5px; font-family: monospace;}
        textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.2s; color: white; }
        
        #analyzeBtn { background: #4f46e5; }
        #saveBtn { background: #059669; display: none; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #status-log { margin-top: 20px; padding: 15px; background: #1e293b; color: #4ade80; font-family: monospace; border-radius: 6px; height: 150px; overflow-y: auto; display: none; font-size: 0.9rem; }
/* --- [ì¶”ê°€] ëª¨ë‹¬(Modal) ê´€ë ¨ ìŠ¤íƒ€ì¼ --- */
        .modal {
            position: fixed; /* í™”ë©´ì— ê³ ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            display: flex;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
            align-items: center;
            z-index: 10000; /* ë§¨ ìœ„ì— í‘œì‹œ */
        }

        /* hidden í´ë˜ìŠ¤ê°€ ë¶™ìœ¼ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ */
        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
            max-width: 800px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            max-height: 85vh; /* ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            color: #1f2937;
        }
/* --- [ìˆ˜ì •] ëª¨ë‹¬ ë””ìì¸ ê°œì„  (Xë²„íŠ¼ & ìŠ¤ìº”ë²„íŠ¼) --- */

/* 1. X ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.close-modal-btn {
    background: none;
    border: none;
    color: #9ca3af; /* ì—°í•œ íšŒìƒ‰ (ê¸°ë³¸) */
    font-size: 1.8rem;
    cursor: pointer;
    padding: 0 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    line-height: 1;
}

.close-modal-btn:hover {
    color: #ef4444; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë¹¨ê°„ìƒ‰ */
    background-color: #f3f4f6; /* ë°°ê²½ì€ ì•„ì£¼ ì—°í•œ íšŒìƒ‰ */
    transform: scale(1.1); /* ì‚´ì§ ì»¤ì§ */
}

/* 2. ìŠ¤ìº” ë²„íŠ¼ ìŠ¤íƒ€ì¼ (Scan Storage) */
.btn-scan {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); /* ë³´ë¼ë¹› ê·¸ë¼ë””ì–¸íŠ¸ */
    color: white;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); /* ê·¸ë¦¼ì */
    transition: all 0.2s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.btn-scan:hover {
    background: linear-gradient(135deg, #4338ca 0%, #312e81 100%);
    transform: translateY(-2px); /* ì‚´ì§ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
}

.btn-scan:active {
    transform: translateY(0);
}

.btn-scan:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}
/* [ì¶”ê°€] ë¹¨ê°„ ì (Red Dot) ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .red-dot {
        position: absolute;
        top: 0;
        right: 0;
        width: 12px;
        height: 12px;
        background-color: #ef4444; /* ë¹¨ê°„ìƒ‰ */
        border-radius: 50%;
        border: 2px solid white;
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
/* --- [ì¶”ê°€] ì•„ì½”ë””ì–¸ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ --- */
    .pending-item {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        margin-bottom: 10px;
        overflow: hidden;
        background: white;
        transition: all 0.2s;
    }
    
    .pending-header {
        padding: 15px;
        background: #f8fafc;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
        color: #334155;
    }
    
    .pending-header:hover {
        background: #f1f5f9;
        color: #2563eb;
    }

    .pending-content {
        display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        padding: 20px;
        border-top: 1px solid #e2e8f0;
        background: #fff;
        font-size: 0.9rem;
        line-height: 1.6;
    }

    /* í™œì„±í™” ìƒíƒœ */
    .pending-item.active .pending-content {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
        display: inline-block;
        margin-right: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
/* --- [NEW] RAG DB ê´€ë¦¬ìš© ìŠ¤íƒ€ì¼ --- */
    #btn-rag-db {
        position: fixed; top: 20px; left: 30px; 
        background: #1e293b; color: white; padding: 10px 16px; border-radius: 25px; 
        font-weight: bold; cursor: pointer; z-index: 999; border: 1px solid #334155;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s;
    }
    #btn-rag-db:hover { background: #334155; transform: translateY(-2px); }

    .rag-container { display: flex; gap: 20px; height: 500px; }
    .rag-list { flex: 1; border-right: 1px solid #e5e7eb; overflow-y: auto; padding-right: 10px; }
    .rag-detail { flex: 2; padding-left: 10px; display: flex; flex-direction: column; }
    
    .rag-item { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s; border-radius: 6px; }
    .rag-item:hover { background: #f8fafc; }
    .rag-item.active { background: #eff6ff; border: 1px solid #bfdbfe; }
    .rag-item-title { font-weight: bold; font-size: 0.95rem; color: #334155; margin-bottom: 4px; display: block; }
    .rag-item-date { font-size: 0.8rem; color: #94a3b8; }

    .rag-input-group { margin-bottom: 15px; }
    .rag-input-label { font-size: 0.85rem; font-weight: bold; color: #64748b; margin-bottom: 5px; display: block; }
    .rag-input { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-family: monospace; font-size: 0.9rem; }
    
    .rag-actions { margin-top: auto; display: flex; gap: 10px; justify-content: flex-end; }
    .btn-delete { background: #ef4444; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
    .btn-update { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; }
    .btn-delete:hover { background: #dc2626; }
    .btn-update:hover { background: #2563eb; }
    </style>
</head>
<body>
<button id="btn-rag-db" onclick="openRagDbModal()">ğŸ—„ï¸ Access RAG DB</button>
<div id="notification-bell" onclick="handleNotificationClick()" style="position:fixed; top:20px; right:30px; cursor:pointer; z-index:9999;">
    <span style="font-size: 1.8rem;">ğŸ””</span>
    <span id="red-dot" class="red-dot"></span>
</div>

<div id="pending-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 700px; border-radius: 16px;">
        <div class="modal-header">
            <h3 style="margin:0;">â³ ìŠ¹ì¸ ëŒ€ê¸° ëª©ë¡</h3>
            <button onclick="document.getElementById('pending-modal').classList.add('hidden')" class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div id="pending-list-container" style="max-height: 500px; overflow-y: auto; padding: 5px;">
                </div>
        </div>
    </div>
</div>

<div id="rag-db-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 900px; height: 700px;">
        <div class="modal-header">
            <h3 style="margin:0;">ğŸ› ï¸ RAG ë°ì´í„°ë² ì´ìŠ¤ ê´€ë¦¬ (Pinecone)</h3>
            <button onclick="document.getElementById('rag-db-modal').classList.add('hidden')" class="close-modal-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div class="rag-container">
                <div class="rag-list" id="rag-list-container">
                    <div style="text-align:center; padding:20px; color:#94a3b8;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                </div>
                
                <div class="rag-detail" id="rag-detail-container" style="visibility: hidden;">
                    <input type="hidden" id="rag-edit-id">
                    
                    <div class="rag-input-group">
                        <span class="rag-input-label">ë¬¸ì„œ ìœ í˜• (Doc Type)</span>
                        <input type="text" id="rag-edit-type" class="rag-input">
                    </div>

                    <div class="rag-input-group">
                        <span class="rag-input-label">ì‚¬ìš©ì ê²€í†  ì˜ê²¬ (User Feedback)</span>
                        <input type="text" id="rag-edit-feedback" class="rag-input">
                    </div>

                    <div class="rag-input-group" style="flex:1; display:flex; flex-direction:column;">
                        <span class="rag-input-label">ì €ì¥ëœ ì „ì²´ ë‚´ìš© (Full Content - ìˆ˜ì • ì‹œ ë²¡í„° ì¬ìƒì„±ë¨)</span>
                        <textarea id="rag-edit-content" class="rag-input" style="flex:1; resize:none;"></textarea>
                    </div>

                    <div class="rag-actions">
                        <button class="btn-delete" onclick="deleteRagItem()">ğŸ—‘ï¸ ì‚­ì œ (Delete)</button>
                        <button class="btn-update" onclick="updateRagItem()">ğŸ’¾ ìˆ˜ì • ì €ì¥ (Update)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <h1>ğŸ‘¨â€ğŸ« AI ë²•ë¥  ë¬¸ì„œ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</h1>
    <p style="color:#4b5563; margin-bottom:30px;">ê·œì¹™ë§Œ ì ìš©í–ˆì„ ë•Œì™€ RAG DBë¥¼ ì ìš©í–ˆì„ ë•Œë¥¼ ë¹„êµí•˜ì—¬ ìµœì ì˜ ì§€ì‹ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.</p>

    <div style="margin-bottom: 20px;">
        <span class="label">ë¬¸ì„œ ì¢…ë¥˜ ì„ íƒ</span>
        <select id="docType">
            <option value="default">ê¸°ë³¸ ë¬¸ì„œ</option>
            <option value="judgment">íŒê²°ë¬¸</option>
            <option value="contract">ì‚¬ê±´ìœ„ì„ê³„ì•½ì„œ</option>
            <option value="receipt">ì˜ìˆ˜ì¦/ì²­êµ¬ì„œ</option>
            <option value="transfer">ì´ì²´ë‚´ì—­</option>
            <option value="powerofattorney">ì‚¬ê±´ìœ„ì„ì¥</option>
        </select>
    </div>

    <div class="section">
        <span class="label">Step 1. í•™ìŠµí•  ë¬¸ì„œ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</span>
        <div class="drop-zone" id="dropZone">
            <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”. (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</p>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf, .png, .jpg, .jpeg" multiple>
        </div>
        <div id="file-info" style="margin-top:10px; font-weight:bold; color:#2563eb; display:none;"></div>
    </div>

    <div class="section">
        <span class="label">Step 2. ğŸ” ì½ëŠ” ë°©ë²• í™•ì¸ (Extraction)</span>
        <div id="extractionDisplay" class="ai-result-box box-blue">
            <span class="ai-title" style="color:#0284c7;">ğŸ¤– AI Extraction ê²°ê³¼</span>
            <div id="extractionText" class="ai-content"></div>
        </div>
        <textarea id="readingStrategy" placeholder="í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì˜ëª»ë˜ì—ˆë‹¤ë©´ ìˆ˜ì •í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="section">
        <span class="label">Step 3. ğŸ§  í•´ì„ ë…¼ë¦¬ ë¹„êµ (Logic Comparison)</span>
        <span class="sub-label">ë‘ ê°€ì§€ ê²°ê³¼ë¥¼ ë¹„êµí•˜ì—¬ RAG DBê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</span>

        <div id="logicBaselineDisplay" class="ai-result-box box-gray">
            <span class="ai-title" style="color:#475569;">ğŸ§© [Baseline] GitHub ê·œì¹™ë§Œ ì ìš©í•œ ê²°ê³¼</span>
            <div id="logicBaselineText" class="ai-content"></div>
        </div>

        <div id="logicRAGDisplay" class="ai-result-box box-purple">
            <span class="ai-title" style="color:#7c3aed;">ğŸ”® [RAG Enhanced] GitHub ê·œì¹™ + DB ê³¼ê±°ì‚¬ë¡€ ì ìš© ê²°ê³¼</span>
            <div id="logicRAGText" class="ai-content"></div>
        </div>

        <span class="sub-label" style="margin-top:10px;">ğŸ‘‡ ìµœì¢…ì ìœ¼ë¡œ í•™ìŠµì‹œí‚¬ ë‚´ìš©ì„ ì•„ë˜ì— ì •ë¦¬í•´ì£¼ì„¸ìš”.</span>
        <textarea id="logicRule" placeholder="AIê°€ ë‚˜ì¤‘ì— ì°¸ê³ í•´ì•¼ í•  ì˜¬ë°”ë¥¸ í•´ì„ ë…¼ë¦¬ë¥¼ ìµœì¢… ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="btn-group">
        <button id="analyzeBtn" class="btn" onclick="analyzeDocument()">Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰ (Baseline vs RAG)</button>
        <button id="saveBtn" class="btn" onclick="saveKnowledge()">Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥</button>
    </div>

    <div id="status-log"></div>
</div>

<script>
    let selectedFiles = []; // [ìˆ˜ì •] ë°°ì—´ë¡œ ë³€ê²½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('status-log');

    // Display Elements
    const extractionDisplay = document.getElementById('extractionDisplay');
    const extractionText = document.getElementById('extractionText');
    const logicBaselineDisplay = document.getElementById('logicBaselineDisplay');
    const logicBaselineText = document.getElementById('logicBaselineText');
    const logicRAGDisplay = document.getElementById('logicRAGDisplay');
    const logicRAGText = document.getElementById('logicRAGText');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Drag & Drop
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    };
    fileInput.onchange = (e) => handleFiles(e.target.files);

    // [ìˆ˜ì •] íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFiles(files) {
        if (!files || files.length === 0) return;
        selectedFiles = Array.from(files); // FileList -> Array ë³€í™˜
        
        const fileNames = selectedFiles.map(f => f.name).join(", ");
        document.getElementById('file-info').style.display = 'block';
        document.getElementById('file-info').innerText = `ì„ íƒëœ íŒŒì¼ (${selectedFiles.length}ê°œ): ${fileNames}`;
        resetUI();
    }

    function resetUI() {
        extractionDisplay.style.display = 'none';
        logicBaselineDisplay.style.display = 'none';
        logicRAGDisplay.style.display = 'none';
        
        saveBtn.style.display = 'none';
        analyzeBtn.style.display = 'block';
        analyzeBtn.disabled = false;
        logDiv.style.display = 'none';
    }

    function log(msg, type='info') {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#f87171' : '#4ade80';
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function formatAIOutput(data) {
        if (typeof data === 'object' && data !== null) {
            return JSON.stringify(data, null, 2);
        }
        return data;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });
    }

    // [Step 1] ë¶„ì„ ìš”ì²­ (ë‹¤ì¤‘ íŒŒì¼)
    async function analyzeDocument() {
        if (selectedFiles.length === 0) { alert("íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); return; }
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "GitHub ê·œì¹™ ë° DB ê²€ìƒ‰ ì¤‘...";
        logDiv.innerHTML = "";
        
        try {
            const docType = document.getElementById('docType').value;

            // [ìˆ˜ì •] ëª¨ë“  íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ë¡œ ë§Œë“¦
            const filesPayload = await Promise.all(selectedFiles.map(async (file) => {
                const base64 = await fileToBase64(file);
                return {
                    fileBase64: base64,
                    mimeType: file.type,
                    fileName: file.name
                };
            }));

            log(`ğŸš€ íŒŒì¼ ${selectedFiles.length}ê°œ ë¶„ì„ ìš”ì²­ ì¤‘...`);
            
            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'analyze',
                    files: filesPayload, // [ì¤‘ìš”] ë°°ì—´ ì „ì†¡
                    docType: docType
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            // ê²°ê³¼ í‘œì‹œ
            extractionDisplay.style.display = 'block';
            extractionText.innerText = formatAIOutput(result.data.extraction);
            
            logicBaselineDisplay.style.display = 'block';
            logicBaselineText.innerText = formatAIOutput(result.data.analysis_baseline);

            logicRAGDisplay.style.display = 'block';
            logicRAGText.innerText = formatAIOutput(result.data.analysis_rag);

            log("âœ… ë¹„êµ ë¶„ì„ ì™„ë£Œ! ë‘ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìµœì¢… í•™ìŠµ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”.");
            
            analyzeBtn.style.display = 'none';
            saveBtn.style.display = 'block';

        } catch (e) {
            log(`âŒ ì—ëŸ¬ ë°œìƒ: ${e.message}`, 'error');
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰";
        }
    }

    // [Step 2] ì €ì¥
    async function saveKnowledge() {
        saveBtn.disabled = true;
        saveBtn.innerText = "ì €ì¥ ì¤‘...";

        try {
            const readingStrategy = document.getElementById('readingStrategy').value;
            const logicRule = document.getElementById('logicRule').value;
            
            const extractionVal = document.getElementById('extractionText').innerText;
            const analysisRAGVal = document.getElementById('logicRAGText').innerText;
            const docType = document.getElementById('docType').value;

            const finalFeedback = `
            [Reading Instruction]: ${readingStrategy || "AI ì¶”ì¶œ ê²°ê³¼ ìŠ¹ì¸"}
            [Logic Instruction]: ${logicRule || "AI RAG ë¶„ì„ ê²°ê³¼ ìŠ¹ì¸"}
            `;

            log("ğŸ’¾ ê²€ì¦ëœ ë°ì´í„° ì €ì¥ ì¤‘...");

            // [ìˆ˜ì •] íŒŒì¼ ì •ë³´ë¥¼ ë‹¤ì‹œ ì „ì†¡ (íŒŒì¼ëª… ì €ì¥ì„ ìœ„í•´)
            const filesPayload = selectedFiles.map(f => ({ fileName: f.name }));

            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'save',
                    docType: docType,
                    files: filesPayload, // íŒŒì¼ ì •ë³´(ì´ë¦„) ì „ì†¡
                    extraction: extractionVal,
                    analysis: logicRule ? logicRule : analysisRAGVal,
                    userFeedback: finalFeedback
                })
            });

            const result = await response.json();
            if(!result.success) throw new Error(result.error);

            log(`ğŸ‰ ì €ì¥ ì™„ë£Œ! (ID: ${result.upsertId})`);
            alert("í•™ìŠµ ì™„ë£Œ!");
            
            resetUI();
            selectedFiles = [];
            document.getElementById('fileInput').value = "";
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('readingStrategy').value = "";
            document.getElementById('logicRule').value = "";

        } catch (e) {
            log(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerText = "Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥";
        }
    }

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ê¸°ì—´ í™•ì¸
window.addEventListener('DOMContentLoaded', () => {
    checkPendingDocs();
    // 30ì´ˆë§ˆë‹¤ ìë™ í™•ì¸ (ì˜µì…˜)
    setInterval(checkPendingDocs, 30000);
});

// =========================================================
    // [í†µí•©] ì•Œë¦¼ ë° ëŒ€ê¸°ì—´ ê´€ë¦¬ ë¡œì§ (Red Dot & Accordion)
    // =========================================================

    // 1. í˜ì´ì§€ ë¡œë“œ ì‹œ & ì£¼ê¸°ì ìœ¼ë¡œ ëŒ€ê¸°ì—´ í™•ì¸
    window.addEventListener('DOMContentLoaded', () => {
        checkPendingDocs();
        setInterval(checkPendingDocs, 30000); // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
        
        // [ì¶”ê°€] í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ë¬¸ì„œ ë¶„ì„ ì‹œì‘ (API í˜¸ì¶œ)
        console.log("ğŸ”„ í˜ì´ì§€ ì ‘ì† ê°ì§€: ì‹ ê·œ ë¬¸ì„œ ìë™ ë¶„ì„ ì‹œì‘...");
        fetch('/api/check-new-docs', { method: 'POST' }).catch(err => console.error("ìë™ ë¶„ì„ ì‹¤íŒ¨:", err));
    });

    // [Red Dot] ëŒ€ê¸° ë¬¸ì„œ ê°œìˆ˜ í™•ì¸ (ë‹¨ìˆœ ì¹´ìš´íŠ¸)
    async function checkPendingDocs() {
        try {
            const res = await fetch('/api/check-new-docs?mode=count');
            const data = await res.json();
            
            const dot = document.getElementById('red-dot');
            if (data.success && data.count > 0) {
                dot.style.display = 'block';
                console.log(`ğŸ”” ì•Œë¦¼: ëŒ€ê¸° ë¬¸ì„œ ${data.count}ê±´ ë°œê²¬`);
            } else {
                dot.style.display = 'none';
            }
        } catch (e) { 
            console.error("ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨", e); 
        }
    }

    // [Modal Open] ì¢… ëª¨ì–‘ í´ë¦­ -> ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ ë° ëª¨ë‹¬ ì—´ê¸°
    async function handleNotificationClick() {
        const modal = document.getElementById('pending-modal');
        const container = document.getElementById('pending-list-container');
        
        modal.classList.remove('hidden');
        container.innerHTML = '<div style="text-align:center; padding:20px;">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        try {
            // mode=list í˜¸ì¶œ
            const res = await fetch('/api/check-new-docs?mode=list');
            const data = await res.json();

            if (!data.success || !data.list || data.list.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px;">ì²˜ë¦¬í•  ëŒ€ê¸° ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                document.getElementById('red-dot').style.display = 'none'; // ì  ë„ê¸°
                return;
            }

            // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
            container.innerHTML = '';
            data.list.forEach(doc => {
                const date = new Date(doc.created_at).toLocaleString();
                // ì´ë¯¸ statusê°€ errorì¸ ê²½ìš° í‘œì‹œ
                const errorBadge = doc.status === 'error' ? '<span style="color:red; font-size:0.8em;">(ì˜¤ë¥˜ ì¬ì‹œë„)</span> ' : '';

                const item = document.createElement('div');
                item.className = 'pending-item';
                item.id = `doc-${doc.id}`;
                
                // í—¤ë” í´ë¦­ ì‹œ toggleAccordion í˜¸ì¶œ
                item.innerHTML = `
                    <div class="pending-header" onclick="toggleAccordion('${doc.id}', '${doc.filename}')">
                        <span>ğŸ“„ ${errorBadge}${doc.filename}</span>
                        <span style="font-size:0.8em; color:#94a3b8;">${date} â–¼</span>
                    </div>
                    <div class="pending-content" id="content-${doc.id}">
                        <div style="text-align:center; color:#64748b; padding:20px;">
                            <div class="spinner"></div><br>AIê°€ ë¬¸ì„œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...<br>(ë¬¸ì„œ ë‚œì´ë„ì— ë”°ë¼ 30ì´ˆ~1ë¶„ ì†Œìš”)
                        </div>
                    </div>
                `;
                container.appendChild(item);
            });

        } catch (e) {
            container.innerHTML = `<div style="color:red; text-align:center;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
        }
    }

    // [Accordion] í† ê¸€ ë° ê°œë³„ ë¶„ì„ ìš”ì²­
    async function toggleAccordion(docId, filename) {
        const item = document.getElementById(`doc-${docId}`);
        const contentDiv = document.getElementById(`content-${docId}`);
        
        // ì´ë¯¸ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸° (í† ê¸€)
        if (item.classList.contains('active')) {
            item.classList.remove('active');
            return;
        }

        // ë‹¤ë¥¸ ì—´ë¦° í•­ëª©ë“¤ ë‹«ê¸° (í•˜ë‚˜ë§Œ ì—´ë¦¬ê²Œ í•˜ê¸° ìœ„í•¨)
        document.querySelectorAll('.pending-item').forEach(el => el.classList.remove('active'));
        
        // í˜„ì¬ í•­ëª© ì—´ê¸°
        item.classList.add('active');

        // ì´ë¯¸ ë¶„ì„ëœ ë‚´ìš©ì´ ìˆìœ¼ë©´ ë‹¤ì‹œ ìš”ì²­í•˜ì§€ ì•ŠìŒ (dataset í”Œë˜ê·¸ í™œìš©)
        if (item.dataset.analyzed === "true") return;

        // [í•µì‹¬] ê°œë³„ ë¶„ì„ ìš”ì²­ (docId í¬í•¨ POST)
        try {
            const res = await fetch('/api/check-new-docs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ docId: docId }) // íŠ¹ì • ë¬¸ì„œ ID ì „ì†¡
            });
            
            const result = await res.json();
            
            if (result.success && result.processed && result.processed.length > 0) {
                const data = result.processed[0];
                
                if (data.status === 'error') {
                     contentDiv.innerHTML = `<div style="color:red; padding:10px;">âŒ ë¶„ì„ ì‹¤íŒ¨: ${data.error}</div>`;
                } else {
                    // ë¶„ì„ ì„±ê³µ ê²°ê³¼ í‘œì‹œ
                    const aiResult = data.result; 
                    
                    // ì´ìŠˆ ë¦¬ìŠ¤íŠ¸ ìƒì„±
                    const issuesHtml = aiResult.issues 
                        ? aiResult.issues.map(i => `<li>${i}</li>`).join('') 
                        : '<li>íŠ¹ì´ì‚¬í•­ ì—†ìŒ</li>';

                    contentDiv.innerHTML = `
                        <div style="background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid #bae6fd;">
                            <strong style="color:#0369a1;">ğŸ“Œ í•µì‹¬ ìŸì </strong>
                            <ul style="margin:5px 0 0 20px; color:#334155;">${issuesHtml}</ul>
                        </div>
                        <div style="background:#f5f3ff; padding:15px; border-radius:8px; border:1px solid #ddd6fe;">
                            <strong style="color:#7c3aed;">ğŸ”® RAG ë¶„ì„ ê²°ê³¼</strong>
                            <p style="margin:8px 0 0 0; white-space:pre-wrap; color:#4b5563; font-size:0.95rem;">${aiResult.step3_rag_analysis || aiResult.step3 || "ê²°ê³¼ ë‚´ìš© ì—†ìŒ"}</p>
                        </div>
                        
                        <textarea id="feedback-${docId}" placeholder="ì´ ë¬¸ì„œì— ëŒ€í•œ ê²€í†  ì˜ê²¬ì„ ì…ë ¥í•˜ì„¸ìš”. (ì„ íƒì‚¬í•­)" style="width:100%; height:80px; margin-top:10px; padding:10px; border:1px solid #cbd5e1; border-radius:6px; font-family:monospace;"></textarea>

                        <button onclick="approveDoc('${docId}')" style="width:100%; margin-top:15px; padding:12px; background:#22c55e; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:bold; font-size:1rem;">
                            âœ… ê²€í†  ì™„ë£Œ (Pinecone ì €ì¥)
                        </button>
                    `;
                    item.dataset.analyzed = "true"; // ë¶„ì„ ì™„ë£Œ í”Œë˜ê·¸ ì„¤ì •
                    
                    // í•˜ë‚˜ ì²˜ë¦¬í–ˆìœ¼ë¯€ë¡œ ë¹¨ê°„ ì  ìƒíƒœ ê°±ì‹ 
                    checkPendingDocs();
                }
            } else {
                contentDiv.innerHTML = "<div style='padding:10px;'>ë¶„ì„ ê²°ê³¼ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</div>";
            }

        } catch (e) {
            contentDiv.innerHTML = `<div style="color:red; padding:10px;">í†µì‹  ì˜¤ë¥˜: ${e.message}</div>`;
        }
    }

    // [Approve] ê²€í†  ì™„ë£Œ ì²˜ë¦¬ (DB ì €ì¥ ìš”ì²­)
    async function approveDoc(docId) {
        const item = document.getElementById(`doc-${docId}`);
        const feedback = document.getElementById(`feedback-${docId}`)?.value || ""; // ì…ë ¥ëœ í”¼ë“œë°± ê°€ì ¸ì˜¤ê¸°

        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        const btn = item.querySelector('button');
        const originalText = btn.innerText;
        btn.disabled = true;
        btn.innerText = "ì €ì¥ ì¤‘...";

        try {
            // [API í˜¸ì¶œ] confirm-review.js í˜¸ì¶œ
            const response = await fetch('/api/confirm-review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    docId: docId, 
                    userFeedback: feedback 
                })
            });

            const result = await response.json();

            if (!result.success) {
                throw new Error(result.error || "ì €ì¥ ì‹¤íŒ¨");
            }

            // ì„±ê³µ ì‹œ UI ì• ë‹ˆë©”ì´ì…˜
            alert("âœ… RAG ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");

            // ë¶€ë“œëŸ½ê²Œ ì‚¬ë¼ì§€ëŠ” íš¨ê³¼
            item.style.transition = "opacity 0.3s, transform 0.3s";
            item.style.opacity = '0';
            item.style.transform = "translateX(20px)";
            
            setTimeout(() => {
                item.remove();
                // ëª©ë¡ì´ ë¹„ì—ˆìœ¼ë©´ ëª¨ë‹¬ ë‹«ê¸°
                if (document.querySelectorAll('.pending-item').length === 0) {
                    document.getElementById('pending-modal').classList.add('hidden');
                }
                // ë¹¨ê°„ ì  ê°±ì‹ 
                checkPendingDocs();
            }, 300);

        } catch (error) {
            console.error("ì €ì¥ ì˜¤ë¥˜:", error);
            alert(`âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ì›ë³µ
            btn.disabled = false;
            btn.innerText = originalText;
        }
    }
// =========================================================
// [NEW] RAG DB ê´€ë¦¬ ìŠ¤í¬ë¦½íŠ¸
// =========================================================
    
    // ëª¨ë‹¬ ì—´ê¸° & ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
    async function openRagDbModal() {
        document.getElementById('rag-db-modal').classList.remove('hidden');
        const listContainer = document.getElementById('rag-list-container');
        document.getElementById('rag-detail-container').style.visibility = 'hidden';
        
        listContainer.innerHTML = '<div style="text-align:center; padding:20px;">ë°ì´í„° ë¡œë”© ì¤‘...</div>';

        try {
            const res = await fetch('/api/manage-rag-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'list' })
            });
            const data = await res.json();
            
            if(!data.success || data.list.length === 0) {
                listContainer.innerHTML = '<div style="text-align:center; padding:20px;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            listContainer.innerHTML = '';
            data.list.forEach(doc => {
                const el = document.createElement('div');
                el.className = 'rag-item';
                el.onclick = () => loadRagDetail(doc.id, el);
                el.innerHTML = `
                    <span class="rag-item-title">${doc.filename}</span>
                    <span class="rag-item-date">${new Date(doc.created_at).toLocaleDateString()}</span>
                `;
                listContainer.appendChild(el);
            });

        } catch(e) {
            listContainer.innerHTML = `<div style="color:red; padding:10px;">ë¡œë”© ì‹¤íŒ¨: ${e.message}</div>`;
        }
    }

    // ìƒì„¸ ë‚´ìš© ë¶ˆëŸ¬ì˜¤ê¸° (Pinecone)
    async function loadRagDetail(id, element) {
        // Highlight active item
        document.querySelectorAll('.rag-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');

        // Show Loading
        const detailContainer = document.getElementById('rag-detail-container');
        detailContainer.style.visibility = 'visible';
        document.getElementById('rag-edit-content').value = "Loading from Pinecone...";
        
        try {
            const res = await fetch('/api/manage-rag-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'get', docId: id })
            });
            const result = await res.json();

            if(result.success) {
                const meta = result.data || {};
                document.getElementById('rag-edit-id').value = id;
                document.getElementById('rag-edit-type').value = meta.docType || '';
                document.getElementById('rag-edit-feedback').value = meta.userFeedback || '';
                document.getElementById('rag-edit-content').value = meta.fullContent || '';
            } else {
                alert("ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        } catch(e) {
            console.error(e);
            alert("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
        }
    }

    // ìˆ˜ì • (Update)
    async function updateRagItem() {
        const id = document.getElementById('rag-edit-id').value;
        if(!id) return;

        if(!confirm("ë‚´ìš©ì„ ìˆ˜ì •í•˜ë©´ AIê°€ ì´ë¥¼ ë‹¤ì‹œ í•™ìŠµ(Embedding)í•©ë‹ˆë‹¤. ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const payload = {
            docType: document.getElementById('rag-edit-type').value,
            userFeedback: document.getElementById('rag-edit-feedback').value,
            fullContent: document.getElementById('rag-edit-content').value
        };

        const btn = document.querySelector('.btn-update');
        const prevText = btn.innerText;
        btn.innerText = "ì²˜ë¦¬ ì¤‘...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/manage-rag-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'update', docId: id, payload: payload })
            });
            const result = await res.json();
            if(result.success) {
                alert("âœ… ìˆ˜ì • ì™„ë£Œ! Pinecone ë°ì´í„°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } else {
                alert("ìˆ˜ì • ì‹¤íŒ¨: " + result.error);
            }
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        } finally {
            btn.innerText = prevText;
            btn.disabled = false;
        }
    }

    // ì‚­ì œ (Delete)
    async function deleteRagItem() {
        const id = document.getElementById('rag-edit-id').value;
        if(!id) return;
        
        if(!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

        try {
            const res = await fetch('/api/manage-rag-db', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'delete', docId: id })
            });
            const result = await res.json();
            
            if(result.success) {
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                openRagDbModal(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨: " + result.error);
            }
        } catch(e) {
            alert("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
        }
    }
</script>
</body>
</html>