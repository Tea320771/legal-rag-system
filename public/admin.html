<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë²•ë¥  ë¬¸ì„œ í•™ìŠµ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 40px; background: #f3f4f6; color: #1f2937; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #111827; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
        
        .section { margin-bottom: 30px; }
        .label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; font-size: 1.1rem; }
        .sub-label { display: block; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; }
        
        .drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.2s; background: #f9fafb; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        
        .ai-result-box { padding: 15px; margin-bottom: 10px; border-radius: 6px; display: none; border-left-width: 5px; border-left-style: solid; }
        .ai-title { font-weight: bold; margin-bottom: 5px; display: block; font-size: 0.95rem;}
        .ai-content { white-space: pre-wrap; font-size: 0.9rem; color: #334155; font-family: monospace; }

        .box-blue { background-color: #f0f9ff; border-left-color: #0ea5e9; }
        .box-gray { background-color: #f1f5f9; border-left-color: #64748b; }
        .box-purple { background-color: #f5f3ff; border-left-color: #8b5cf6; }
        
        select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; margin-bottom: 5px; font-family: monospace;}
        textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.2s; color: white; }
        
        #analyzeBtn { background: #4f46e5; }
        #saveBtn { background: #059669; display: none; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #status-log { margin-top: 20px; padding: 15px; background: #1e293b; color: #4ade80; font-family: monospace; border-radius: 6px; height: 150px; overflow-y: auto; display: none; font-size: 0.9rem; }
/* --- [ì¶”ê°€] ëª¨ë‹¬(Modal) ê´€ë ¨ ìŠ¤íƒ€ì¼ --- */
        .modal {
            position: fixed; /* í™”ë©´ì— ê³ ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ë°°ê²½ì„ ì–´ë‘¡ê²Œ */
            display: flex;
            justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
            align-items: center;
            z-index: 10000; /* ë§¨ ìœ„ì— í‘œì‹œ */
        }

        /* hidden í´ë˜ìŠ¤ê°€ ë¶™ìœ¼ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ */
        .modal.hidden {
            display: none !important;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            width: 90%; /* ëª¨ë°”ì¼ ëŒ€ì‘ */
            max-width: 800px; /* ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            max-height: 85vh; /* ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ìŠ¤í¬ë¡¤ */
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .modal-header h3 {
            margin: 0;
            color: #1f2937;
        }
/* --- [ìˆ˜ì •] ëª¨ë‹¬ ë””ìì¸ ê°œì„  (Xë²„íŠ¼ & ìŠ¤ìº”ë²„íŠ¼) --- */

/* 1. X ë‹«ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.close-modal-btn {
    background: none;
    border: none;
    color: #9ca3af; /* ì—°í•œ íšŒìƒ‰ (ê¸°ë³¸) */
    font-size: 1.8rem;
    cursor: pointer;
    padding: 0 8px;
    border-radius: 4px;
    transition: all 0.2s ease;
    line-height: 1;
}

.close-modal-btn:hover {
    color: #ef4444; /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë¹¨ê°„ìƒ‰ */
    background-color: #f3f4f6; /* ë°°ê²½ì€ ì•„ì£¼ ì—°í•œ íšŒìƒ‰ */
    transform: scale(1.1); /* ì‚´ì§ ì»¤ì§ */
}

/* 2. ìŠ¤ìº” ë²„íŠ¼ ìŠ¤íƒ€ì¼ (Scan Storage) */
.btn-scan {
    width: 100%;
    margin-top: 20px;
    padding: 14px;
    border: none;
    border-radius: 8px;
    background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); /* ë³´ë¼ë¹› ê·¸ë¼ë””ì–¸íŠ¸ */
    color: white;
    font-size: 1rem;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3); /* ê·¸ë¦¼ì */
    transition: all 0.2s ease;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 8px;
}

.btn-scan:hover {
    background: linear-gradient(135deg, #4338ca 0%, #312e81 100%);
    transform: translateY(-2px); /* ì‚´ì§ ë– ì˜¤ë¥´ëŠ” íš¨ê³¼ */
    box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
}

.btn-scan:active {
    transform: translateY(0);
}

.btn-scan:disabled {
    background: #9ca3af;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}
    </style>
</head>
<body>
<div id="notification-bell" onclick="openPendingModal()" style="position:fixed; top:20px; right:30px; cursor:pointer; z-index:9999;">
    <span style="font-size: 1.8rem;">ğŸ””</span>
    <span id="notification-badge" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border-radius:50%; padding:2px 6px; font-size:0.75rem; display:none;">0</span>
</div>

<div id="pending-modal" class="modal hidden">
    <div class="modal-content" style="max-width: 600px; border-radius: 16px;">
        <div class="modal-header" style="border-bottom: 1px solid #f3f4f6; padding-bottom: 15px; margin-bottom: 15px;">
            <div style="display:flex; align-items:center; gap:8px;">
                <span style="font-size:1.5rem;">â³</span>
                <div>
                    <h3 style="margin:0; color:#1f2937; font-size:1.2rem;">ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ë¬¸ì„œ</h3>
                    <span style="font-size:0.85rem; color:#6b7280;">AIê°€ ë¶„ì„ì„ ë§ˆì¹˜ê³  ê²€í† ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
            <button onclick="document.getElementById('pending-modal').classList.add('hidden')" class="close-modal-btn">
                &times;
            </button>
        </div>

        <div class="modal-body">
            <div id="pending-list" style="max-height: 350px; overflow-y: auto; padding-right: 5px;">
                <div style="text-align:center; padding:30px; color:#9ca3af;">
                    ë¡œë”© ì¤‘...
                </div>
            </div>

            <button class="btn-scan" onclick="checkNewFilesManual()">
                <span>ğŸ”„</span>
                <span>ì§€ê¸ˆ ìƒˆ ë¬¸ì„œ í™•ì¸í•˜ê¸° (Scan Storage)</span>
            </button>
        </div>
    </div>
</div>

<div class="container">
    <h1>ğŸ‘¨â€ğŸ« AI ë²•ë¥  ë¬¸ì„œ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</h1>
    <p style="color:#4b5563; margin-bottom:30px;">ê·œì¹™ë§Œ ì ìš©í–ˆì„ ë•Œì™€ RAG DBë¥¼ ì ìš©í–ˆì„ ë•Œë¥¼ ë¹„êµí•˜ì—¬ ìµœì ì˜ ì§€ì‹ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.</p>

    <div style="margin-bottom: 20px;">
        <span class="label">ë¬¸ì„œ ì¢…ë¥˜ ì„ íƒ</span>
        <select id="docType">
            <option value="default">ê¸°ë³¸ ë¬¸ì„œ</option>
            <option value="judgment">íŒê²°ë¬¸</option>
            <option value="contract">ì‚¬ê±´ìœ„ì„ê³„ì•½ì„œ</option>
            <option value="receipt">ì˜ìˆ˜ì¦/ì²­êµ¬ì„œ</option>
            <option value="transfer">ì´ì²´ë‚´ì—­</option>
            <option value="powerofattorney">ì‚¬ê±´ìœ„ì„ì¥</option>
        </select>
    </div>

    <div class="section">
        <span class="label">Step 1. í•™ìŠµí•  ë¬¸ì„œ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</span>
        <div class="drop-zone" id="dropZone">
            <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”. (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</p>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf, .png, .jpg, .jpeg" multiple>
        </div>
        <div id="file-info" style="margin-top:10px; font-weight:bold; color:#2563eb; display:none;"></div>
    </div>

    <div class="section">
        <span class="label">Step 2. ğŸ” ì½ëŠ” ë°©ë²• í™•ì¸ (Extraction)</span>
        <div id="extractionDisplay" class="ai-result-box box-blue">
            <span class="ai-title" style="color:#0284c7;">ğŸ¤– AI Extraction ê²°ê³¼</span>
            <div id="extractionText" class="ai-content"></div>
        </div>
        <textarea id="readingStrategy" placeholder="í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì˜ëª»ë˜ì—ˆë‹¤ë©´ ìˆ˜ì •í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="section">
        <span class="label">Step 3. ğŸ§  í•´ì„ ë…¼ë¦¬ ë¹„êµ (Logic Comparison)</span>
        <span class="sub-label">ë‘ ê°€ì§€ ê²°ê³¼ë¥¼ ë¹„êµí•˜ì—¬ RAG DBê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</span>

        <div id="logicBaselineDisplay" class="ai-result-box box-gray">
            <span class="ai-title" style="color:#475569;">ğŸ§© [Baseline] GitHub ê·œì¹™ë§Œ ì ìš©í•œ ê²°ê³¼</span>
            <div id="logicBaselineText" class="ai-content"></div>
        </div>

        <div id="logicRAGDisplay" class="ai-result-box box-purple">
            <span class="ai-title" style="color:#7c3aed;">ğŸ”® [RAG Enhanced] GitHub ê·œì¹™ + DB ê³¼ê±°ì‚¬ë¡€ ì ìš© ê²°ê³¼</span>
            <div id="logicRAGText" class="ai-content"></div>
        </div>

        <span class="sub-label" style="margin-top:10px;">ğŸ‘‡ ìµœì¢…ì ìœ¼ë¡œ í•™ìŠµì‹œí‚¬ ë‚´ìš©ì„ ì•„ë˜ì— ì •ë¦¬í•´ì£¼ì„¸ìš”.</span>
        <textarea id="logicRule" placeholder="AIê°€ ë‚˜ì¤‘ì— ì°¸ê³ í•´ì•¼ í•  ì˜¬ë°”ë¥¸ í•´ì„ ë…¼ë¦¬ë¥¼ ìµœì¢… ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="btn-group">
        <button id="analyzeBtn" class="btn" onclick="analyzeDocument()">Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰ (Baseline vs RAG)</button>
        <button id="saveBtn" class="btn" onclick="saveKnowledge()">Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥</button>
    </div>

    <div id="status-log"></div>
</div>

<script>
    let selectedFiles = []; // [ìˆ˜ì •] ë°°ì—´ë¡œ ë³€ê²½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('status-log');

    // Display Elements
    const extractionDisplay = document.getElementById('extractionDisplay');
    const extractionText = document.getElementById('extractionText');
    const logicBaselineDisplay = document.getElementById('logicBaselineDisplay');
    const logicBaselineText = document.getElementById('logicBaselineText');
    const logicRAGDisplay = document.getElementById('logicRAGDisplay');
    const logicRAGText = document.getElementById('logicRAGText');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Drag & Drop
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    };
    fileInput.onchange = (e) => handleFiles(e.target.files);

    // [ìˆ˜ì •] íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFiles(files) {
        if (!files || files.length === 0) return;
        selectedFiles = Array.from(files); // FileList -> Array ë³€í™˜
        
        const fileNames = selectedFiles.map(f => f.name).join(", ");
        document.getElementById('file-info').style.display = 'block';
        document.getElementById('file-info').innerText = `ì„ íƒëœ íŒŒì¼ (${selectedFiles.length}ê°œ): ${fileNames}`;
        resetUI();
    }

    function resetUI() {
        extractionDisplay.style.display = 'none';
        logicBaselineDisplay.style.display = 'none';
        logicRAGDisplay.style.display = 'none';
        
        saveBtn.style.display = 'none';
        analyzeBtn.style.display = 'block';
        analyzeBtn.disabled = false;
        logDiv.style.display = 'none';
    }

    function log(msg, type='info') {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#f87171' : '#4ade80';
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function formatAIOutput(data) {
        if (typeof data === 'object' && data !== null) {
            return JSON.stringify(data, null, 2);
        }
        return data;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });
    }

    // [Step 1] ë¶„ì„ ìš”ì²­ (ë‹¤ì¤‘ íŒŒì¼)
    async function analyzeDocument() {
        if (selectedFiles.length === 0) { alert("íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); return; }
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "GitHub ê·œì¹™ ë° DB ê²€ìƒ‰ ì¤‘...";
        logDiv.innerHTML = "";
        
        try {
            const docType = document.getElementById('docType').value;

            // [ìˆ˜ì •] ëª¨ë“  íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ë¡œ ë§Œë“¦
            const filesPayload = await Promise.all(selectedFiles.map(async (file) => {
                const base64 = await fileToBase64(file);
                return {
                    fileBase64: base64,
                    mimeType: file.type,
                    fileName: file.name
                };
            }));

            log(`ğŸš€ íŒŒì¼ ${selectedFiles.length}ê°œ ë¶„ì„ ìš”ì²­ ì¤‘...`);
            
            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'analyze',
                    files: filesPayload, // [ì¤‘ìš”] ë°°ì—´ ì „ì†¡
                    docType: docType
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            // ê²°ê³¼ í‘œì‹œ
            extractionDisplay.style.display = 'block';
            extractionText.innerText = formatAIOutput(result.data.extraction);
            
            logicBaselineDisplay.style.display = 'block';
            logicBaselineText.innerText = formatAIOutput(result.data.analysis_baseline);

            logicRAGDisplay.style.display = 'block';
            logicRAGText.innerText = formatAIOutput(result.data.analysis_rag);

            log("âœ… ë¹„êµ ë¶„ì„ ì™„ë£Œ! ë‘ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìµœì¢… í•™ìŠµ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”.");
            
            analyzeBtn.style.display = 'none';
            saveBtn.style.display = 'block';

        } catch (e) {
            log(`âŒ ì—ëŸ¬ ë°œìƒ: ${e.message}`, 'error');
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰";
        }
    }

    // [Step 2] ì €ì¥
    async function saveKnowledge() {
        saveBtn.disabled = true;
        saveBtn.innerText = "ì €ì¥ ì¤‘...";

        try {
            const readingStrategy = document.getElementById('readingStrategy').value;
            const logicRule = document.getElementById('logicRule').value;
            
            const extractionVal = document.getElementById('extractionText').innerText;
            const analysisRAGVal = document.getElementById('logicRAGText').innerText;
            const docType = document.getElementById('docType').value;

            const finalFeedback = `
            [Reading Instruction]: ${readingStrategy || "AI ì¶”ì¶œ ê²°ê³¼ ìŠ¹ì¸"}
            [Logic Instruction]: ${logicRule || "AI RAG ë¶„ì„ ê²°ê³¼ ìŠ¹ì¸"}
            `;

            log("ğŸ’¾ ê²€ì¦ëœ ë°ì´í„° ì €ì¥ ì¤‘...");

            // [ìˆ˜ì •] íŒŒì¼ ì •ë³´ë¥¼ ë‹¤ì‹œ ì „ì†¡ (íŒŒì¼ëª… ì €ì¥ì„ ìœ„í•´)
            const filesPayload = selectedFiles.map(f => ({ fileName: f.name }));

            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'save',
                    docType: docType,
                    files: filesPayload, // íŒŒì¼ ì •ë³´(ì´ë¦„) ì „ì†¡
                    extraction: extractionVal,
                    analysis: logicRule ? logicRule : analysisRAGVal,
                    userFeedback: finalFeedback
                })
            });

            const result = await response.json();
            if(!result.success) throw new Error(result.error);

            log(`ğŸ‰ ì €ì¥ ì™„ë£Œ! (ID: ${result.upsertId})`);
            alert("í•™ìŠµ ì™„ë£Œ!");
            
            resetUI();
            selectedFiles = [];
            document.getElementById('fileInput').value = "";
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('readingStrategy').value = "";
            document.getElementById('logicRule').value = "";

        } catch (e) {
            log(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerText = "Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥";
        }
    }

// í˜ì´ì§€ ë¡œë“œ ì‹œ ëŒ€ê¸°ì—´ í™•ì¸
window.addEventListener('DOMContentLoaded', () => {
    checkPendingDocs();
    // 30ì´ˆë§ˆë‹¤ ìë™ í™•ì¸ (ì˜µì…˜)
    setInterval(checkPendingDocs, 30000);
});

// 1. ëŒ€ê¸°ì—´ ê°œìˆ˜ í™•ì¸ ë° ë°°ì§€ ì—…ë°ì´íŠ¸
async function checkPendingDocs() {
    // Supabase JS í´ë¼ì´ì–¸íŠ¸ë¥¼ ì“°ê±°ë‚˜, ê°„ë‹¨íˆ APIë¥¼ ë§Œë“¤ì–´ í˜¸ì¶œ
    // ì—¬ê¸°ì„œëŠ” í¸ì˜ìƒ ë°”ë¡œ API í˜¸ì¶œ ì˜ˆì‹œ (ë³„ë„ GET API í•„ìš”) ë˜ëŠ” ì§ì ‘ ì¡°íšŒ ë¡œì§ êµ¬í˜„
    // *ì‹¤ì œ êµ¬í˜„ ì‹œì—ëŠ” /api/get-pending-list ê°™ì€ APIë¥¼ í•˜ë‚˜ ë” ë§Œë“œëŠ” ê²Œ ì¢‹ìŠµë‹ˆë‹¤.
    
    /* ì„ì‹œ: /api/get-pending APIê°€ ìˆë‹¤ê³  ê°€ì • */
    try {
        const res = await fetch('/api/get-pending'); // DBì—ì„œ status='pending' ì¡°íšŒ
        const data = await res.json();
        
        const badge = document.getElementById('notification-badge');
        if (data.count > 0) {
            badge.innerText = data.count;
            badge.style.display = 'block';
            window.pendingDocs = data.items; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        } else {
            badge.style.display = 'none';
        }
    } catch (e) { console.error("ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨", e); }
}

// 2. ëª¨ë‹¬ ì—´ê¸° ë° ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
function openPendingModal() {
    const modal = document.getElementById('pending-modal');
    const list = document.getElementById('pending-list');
    modal.classList.remove('hidden');
    
    if (!window.pendingDocs || window.pendingDocs.length === 0) {
        list.innerHTML = "<p>ëŒ€ê¸° ì¤‘ì¸ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        return;
    }

    list.innerHTML = "";
    window.pendingDocs.forEach((doc, idx) => {
        const item = document.createElement('div');
        item.style.cssText = "border:1px solid #e5e7eb; padding:15px; margin-bottom:10px; border-radius:8px; background:#f9fafb;";
        
        item.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">ğŸ“„ ${doc.filename}</div>
            <div style="font-size:0.85rem; color:#666; margin-bottom:10px;">${new Date(doc.created_at).toLocaleString()} ì—…ë¡œë“œë¨</div>
            <div style="display:flex; gap:10px;">
                <button onclick="reviewPendingItem(${idx})" class="btn-start" style="padding:5px 10px; font-size:0.85rem;">ê²€í†  ë° ìŠ¹ì¸</button>
            </div>
        `;
        list.appendChild(item);
    });
}

// 3. ê²€í†  í™”ë©´ìœ¼ë¡œ ì´ë™ (ë°ì´í„° ì±„ìš°ê¸°)
function reviewPendingItem(idx) {
    const doc = window.pendingDocs[idx];
    document.getElementById('pending-modal').classList.add('hidden');

    // ê¸°ì¡´ extractionDisplay ì˜ì—­ì— ë°ì´í„° ì±„ìš°ê¸°
    document.getElementById('file-info').style.display = 'block';
    document.getElementById('file-info').innerText = `[ê²€í†  ì¤‘] ${doc.filename} (ID: ${doc.id})`;
    
    // AI ê²°ê³¼ ì±„ìš°ê¸°
    const aiData = doc.ai_result;
    document.getElementById('extractionDisplay').style.display = 'block';
    document.getElementById('extractionText').innerText = JSON.stringify(aiData.extraction || aiData.extracted_facts, null, 2);
    
    document.getElementById('logicDisplay').style.display = 'block';
    document.getElementById('logicText').innerText = JSON.stringify(aiData.analysis || aiData.logic_analysis, null, 2);

    // ì €ì¥ ë²„íŠ¼ í™œì„±í™” (ì €ì¥ ì‹œ DB statusë„ ì—…ë°ì´íŠ¸í•´ì•¼ í•¨)
    // *Tip: saveKnowledge í•¨ìˆ˜ë¥¼ ìˆ˜ì •í•˜ì—¬ doc.idë¥¼ ê°™ì´ ë³´ë‚´ì•¼ í•¨
    window.currentPendingDocId = doc.id; 
    
    document.getElementById('analyzeBtn').style.display = 'none';
    document.getElementById('saveBtn').style.display = 'block';
}

// 4. ìˆ˜ë™ ìŠ¤ìº” íŠ¸ë¦¬ê±°
async function checkNewFilesManual() {
    const btn = event.target;
    btn.disabled = true; btn.innerText = "ìŠ¤ìº” ì¤‘...";
    await fetch('/api/check-new-docs', { method: 'POST' });
    await checkPendingDocs();
    openPendingModal(); // ëª©ë¡ ê°±ì‹ 
    btn.disabled = false; btn.innerText = "ğŸ”„ ì§€ê¸ˆ ìƒˆ ë¬¸ì„œ í™•ì¸í•˜ê¸°";
}
</script>
</body>
</html>