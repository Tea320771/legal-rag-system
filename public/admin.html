<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë²•ë¥  ë¬¸ì„œ í•™ìŠµ íŠ¸ë ˆì´ë„ˆ (RAG)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 40px; background: #f3f4f6; color: #1f2937; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #111827; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
        
        .section { margin-bottom: 30px; }
        .label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; }
        .sub-label { display: block; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.2s; background: #f9fafb; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        
        /* ì…ë ¥ í•„ë“œ */
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; margin-bottom: 5px; }
        textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        .btn { background: #2563eb; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; width: 100%; font-weight: bold; transition: background 0.2s; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #status-log { margin-top: 20px; padding: 15px; background: #1e293b; color: #4ade80; font-family: monospace; border-radius: 6px; height: 150px; overflow-y: auto; display: none; font-size: 0.9rem; }
        .log-error { color: #f87171; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘¨â€ğŸ« AI ë²•ë¥  ë¬¸ì„œ íŠ¸ë ˆì´ë„ˆ (RAG)</h1>
    <p style="color:#4b5563; margin-bottom:30px;">AIê°€ í—·ê°ˆë ¤í•˜ëŠ” ë¬¸ì„œë¥¼ ì—…ë¡œë“œí•˜ê³ , <b>ì½ëŠ” ë°©ë²•</b>ê³¼ <b>í•´ì„í•˜ëŠ” ë°©ë²•</b>ì„ ê°€ë¥´ì³ì£¼ì„¸ìš”.</p>

    <div class="section">
        <span class="label">Step 1. í•™ìŠµí•  ë¬¸ì„œ ì—…ë¡œë“œ (íŒê²°ë¬¸, ì˜ìˆ˜ì¦ ë“±)</span>
        <div class="drop-zone" id="dropZone">
            <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf, .png, .jpg, .jpeg">
        </div>
        <div id="file-info" style="margin-top:10px; font-weight:bold; color:#2563eb; display:none;"></div>
    </div>

    <div class="section">
        <span class="label">Step 2. ğŸ” ì½ëŠ” ë°©ë²• êµìœ¡ (Extraction Strategy)</span>
        <span class="sub-label">ë¬¸ì„œì—ì„œ í…ìŠ¤íŠ¸ê°€ ê¹¨ì§€ê±°ë‚˜ íŠ¹ì´í•œ êµ¬ì¡°ì¼ ë•Œ, ì–´ë–»ê²Œ ì½ì–´ì•¼ í•˜ëŠ”ì§€ ì•Œë ¤ì£¼ì„¸ìš”.</span>
        <textarea id="readingStrategy" placeholder="ì˜ˆ: 'ì£¼ë¬¸' í…ìŠ¤íŠ¸ê°€ ë‘ ì¤„ë¡œ ë‚˜ë‰˜ì–´ ìˆì–´ë„ ì´ì–´ì„œ ì½ì–´. ë‚ ì§œ ë’¤ì— ì (.)ì´ ì—†ì–´ë„ ë‚ ì§œë¡œ ì¸ì‹í•´."></textarea>
    </div>

    <div class="section">
        <span class="label">Step 3. ğŸ§  í•´ì„ ë°©ë²• êµìœ¡ (Logic Rule)</span>
        <span class="sub-label">ì¶”ì¶œëœ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë¹„ìœ¨ ê³„ì‚°ì´ë‚˜ ë¹„ìš© ì²˜ë¦¬ë¥¼ ì–´ë–»ê²Œ í• ì§€ ë…¼ë¦¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.</span>
        <textarea id="logicRule" placeholder="ì˜ˆ: 'ê°ì ë¶€ë‹´'ì´ë¼ëŠ” ë‹¨ì–´ê°€ ë‚˜ì˜¤ë©´ ìƒí™˜ ë¹„ìœ¨ì„ 0%ë¡œ ì„¤ì •í•´. í”¼ê³  ì´ë¦„ ë’¤ì— '(ì£¼)'ê°€ ìˆìœ¼ë©´ ë²•ì¸ìœ¼ë¡œ ì²˜ë¦¬í•´."></textarea>
    </div>

    <button id="trainBtn" class="btn" onclick="startTraining()">RAG ë°ì´í„°ë² ì´ìŠ¤ì— ì§€ì‹ ì €ì¥í•˜ê¸°</button>

    <div id="status-log"></div>
</div>

<script>
    let selectedFile = null;
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('status-log');

    // íŒŒì¼ ë“œë˜ê·¸ì•¤ë“œë¡­ UI ë¡œì§
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
    };
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    function handleFile(file) {
        if (!file) return;
        selectedFile = file;
        const info = document.getElementById('file-info');
        info.style.display = 'block';
        info.innerText = `ì„ íƒëœ íŒŒì¼: ${file.name} (${(file.size/1024).toFixed(1)} KB)`;
    }

    function log(msg, type='info') {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#f87171' : '#4ade80';
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });
    }

    async function startTraining() {
        const readingStrategy = document.getElementById('readingStrategy').value.trim();
        const logicRule = document.getElementById('logicRule').value.trim();

        if (!selectedFile) { alert("ë¬¸ì„œ íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); return; }
        if (!readingStrategy && !logicRule) { alert("ì½ëŠ” ë°©ë²• ë˜ëŠ” í•´ì„ ë°©ë²• ì¤‘ í•˜ë‚˜ëŠ” ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); return; }

        const btn = document.getElementById('trainBtn');
        btn.disabled = true;
        btn.innerText = "í•™ìŠµ ì¤‘...";
        logDiv.innerHTML = ""; // ë¡œê·¸ ì´ˆê¸°í™”

        try {
            log("1. íŒŒì¼ ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘...");
            const base64 = await fileToBase64(selectedFile);

            log("2. ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ ë° í•™ìŠµ ìš”ì²­...");
            
            // API í˜¸ì¶œ
            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fileBase64: base64,
                    mimeType: selectedFile.type,
                    fileName: selectedFile.name,
                    readingStrategy: readingStrategy, // ì‚¬ìš©ìì˜ ì½ê¸° ë¹„ë²•
                    logicRule: logicRule              // ì‚¬ìš©ìì˜ í•´ì„ ë¹„ë²•
                })
            });

            if (!response.ok) {
                const errData = await response.json();
                throw new Error(errData.error || "ì„œë²„ ì˜¤ë¥˜");
            }

            const result = await response.json();
            log(`âœ… í•™ìŠµ ì™„ë£Œ! Pineconeì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ${result.upsertId})`);
            alert("í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ AIê°€ ì´ ê·œì¹™ì„ ì°¸ê³ í•©ë‹ˆë‹¤.");
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™”
            document.getElementById('readingStrategy').value = "";
            document.getElementById('logicRule').value = "";

        } catch (e) {
            log(`âŒ í•™ìŠµ ì‹¤íŒ¨: ${e.message}`, 'error');
            console.error(e);
        } finally {
            btn.disabled = false;
            btn.innerText = "RAG ë°ì´í„°ë² ì´ìŠ¤ì— ì§€ì‹ ì €ì¥í•˜ê¸°";
        }
    }
</script>
</body>
</html>