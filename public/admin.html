<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë²•ë¥  ë¬¸ì„œ í•™ìŠµ íŠ¸ë ˆì´ë„ˆ (RAG)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 40px; background: #f3f4f6; color: #1f2937; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #111827; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
        
        .section { margin-bottom: 30px; }
        .label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; font-size: 1.1rem; }
        .sub-label { display: block; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; }
        
        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.2s; background: #f9fafb; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        
        /* AI ê²°ê³¼ ë°•ìŠ¤ */
        .ai-result-box {
            background-color: #f0f9ff;
            border-left: 5px solid #0ea5e9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none; /* ì´ˆê¸°ì—” ìˆ¨ê¹€ */
        }
        .ai-title { font-weight: bold; color: #0284c7; margin-bottom: 5px; display: block; }
        .ai-content { white-space: pre-wrap; font-size: 0.95rem; color: #334155; }

        /* ì…ë ¥ í•„ë“œ */
        select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }
        textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; margin-bottom: 5px; font-family: monospace;}
        textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.2s; color: white; }
        
        #analyzeBtn { background: #4f46e5; } /* ë³´ë¼ìƒ‰ */
        #analyzeBtn:hover { background: #4338ca; }
        
        #saveBtn { background: #059669; display: none; } /* ì´ˆë¡ìƒ‰ */
        #saveBtn:hover { background: #047857; }

        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #status-log { margin-top: 20px; padding: 15px; background: #1e293b; color: #4ade80; font-family: monospace; border-radius: 6px; height: 150px; overflow-y: auto; display: none; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘¨â€ğŸ« AI ë²•ë¥  ë¬¸ì„œ íŠ¸ë ˆì´ë„ˆ (Interactive RAG)</h1>
    <p style="color:#4b5563; margin-bottom:30px;">ë¬¸ì„œë¥¼ ë¶„ì„í•˜ê³ , AIì˜ í•´ì„ ê²°ê³¼ë¥¼ <b>êµì •(Feedback)</b>í•˜ì—¬ í•™ìŠµì‹œí‚µë‹ˆë‹¤.</p>

    <div style="margin-bottom: 20px;">
        <span class="label">ë¬¸ì„œ ì¢…ë¥˜ ì„ íƒ</span>
        <select id="docType">
            <option value="default">ì¼ë°˜ ë¬¸ì„œ</option>
            <option value="judgment">íŒê²°ë¬¸</option>
            <option value="contract">ê³„ì•½ì„œ</option>
            <option value="receipt">ì˜ìˆ˜ì¦/ì²­êµ¬ì„œ</option>
            <option value="registry">ë“±ê¸°ë¶€ë“±ë³¸</option>
        </select>
    </div>

    <div class="section">
        <span class="label">Step 1. í•™ìŠµí•  ë¬¸ì„œ ì—…ë¡œë“œ</span>
        <div class="drop-zone" id="dropZone">
            <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf, .png, .jpg, .jpeg">
        </div>
        <div id="file-info" style="margin-top:10px; font-weight:bold; color:#2563eb; display:none;"></div>
    </div>

    <div class="section">
        <span class="label">Step 2. ğŸ” ì½ëŠ” ë°©ë²• êµìœ¡ (Extraction Strategy)</span>
        
        <div id="extractionDisplay" class="ai-result-box">
            <span class="ai-title">ğŸ¤– AI Extraction ê²°ê³¼ (GitHub ê·œì¹™ ì ìš©ë¨)</span>
            <div id="extractionText" class="ai-content"></div>
        </div>

        <span class="sub-label">ìœ„ AI ê²°ê³¼ê°€ ë¶€ì¡±í•˜ë‹¤ë©´, ì•„ë˜ì— ì˜¬ë°”ë¥¸ ë‚´ìš©ì´ë‚˜ ì½ëŠ” ê·œì¹™ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”.</span>
        <textarea id="readingStrategy" placeholder="AIê°€ í…ìŠ¤íŠ¸ë¥¼ ì˜ëª» ì½ì—ˆë‹¤ë©´ ì—¬ê¸°ì„œ ìˆ˜ì •í•˜ê±°ë‚˜ ê·œì¹™ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="section">
        <span class="label">Step 3. ğŸ§  í•´ì„ ë°©ë²• êµìœ¡ (Logic Rule)</span>

        <div id="logicDisplay" class="ai-result-box" style="border-left-color: #8b5cf6; background-color: #f5f3ff;">
            <span class="ai-title" style="color: #7c3aed;">ğŸ¤– AI Logic ë¶„ì„ ê²°ê³¼ (GitHub ê·œì¹™ ì ìš©ë¨)</span>
            <div id="logicText" class="ai-content"></div>
        </div>

        <span class="sub-label">AIì˜ í•´ì„ ë…¼ë¦¬ê°€ í‹€ë ¸ë‹¤ë©´, ì•„ë˜ì— ì˜¬ë°”ë¥¸ í•´ì„ ë°©ë²•ì„ ì ì–´ì£¼ì„¸ìš”.</span>
        <textarea id="logicRule" placeholder="ë²•ì  í•´ì„ì´ë‚˜ ê³„ì‚° ë…¼ë¦¬ê°€ í‹€ë ¸ë‹¤ë©´ ì—¬ê¸°ì„œ êµì •í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="btn-group">
        <button id="analyzeBtn" class="btn" onclick="analyzeDocument()">Step 1. ë¬¸ì„œ ë¶„ì„ ì‹¤í–‰ (Extraction & Logic)</button>
        <button id="saveBtn" class="btn" onclick="saveKnowledge()">Step 2. êµì • ë‚´ìš© ì €ì¥ (Train DB)</button>
    </div>

    <div id="status-log"></div>
</div>

<script>
    let selectedFile = null;
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('status-log');

    // UI Elements
    const extractionDisplay = document.getElementById('extractionDisplay');
    const extractionText = document.getElementById('extractionText');
    const logicDisplay = document.getElementById('logicDisplay');
    const logicText = document.getElementById('logicText');
    
    const analyzeBtn = document.getElementById('analyzeBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Drag & Drop
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
    };
    fileInput.onchange = (e) => handleFile(e.target.files[0]);

    function handleFile(file) {
        if (!file) return;
        selectedFile = file;
        document.getElementById('file-info').style.display = 'block';
        document.getElementById('file-info').innerText = `ì„ íƒëœ íŒŒì¼: ${file.name}`;
        
        // íŒŒì¼ ë³€ê²½ ì‹œ UI ë¦¬ì…‹
        resetUI();
    }

    function resetUI() {
        extractionDisplay.style.display = 'none';
        logicDisplay.style.display = 'none';
        saveBtn.style.display = 'none';
        analyzeBtn.style.display = 'block';
        analyzeBtn.disabled = false;
        logDiv.style.display = 'none';
    }

    function log(msg, type='info') {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#f87171' : '#4ade80';
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });
    }

    // [Step 1] ë¶„ì„ ìš”ì²­ í•¨ìˆ˜
    async function analyzeDocument() {
        if (!selectedFile) { alert("íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); return; }
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "GitHub ê·œì¹™ ë° ê³¼ê±° ì‚¬ë¡€ ì°¸ì¡°í•˜ì—¬ ë¶„ì„ ì¤‘...";
        logDiv.innerHTML = "";
        
        try {
            const base64 = await fileToBase64(selectedFile);
            const docType = document.getElementById('docType').value;

            log("ğŸš€ GitHub ê·œì¹™ ë° RAG ë°ì´í„° ê²€ìƒ‰ ì¤‘...");
            
            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'analyze', // ë¶„ì„ ëª¨ë“œ
                    fileBase64: base64,
                    mimeType: selectedFile.type,
                    fileName: selectedFile.name,
                    docType: docType
                })
            });

            const result = await response.json();
            
            if (!result.success) throw new Error(result.error);

            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            extractionDisplay.style.display = 'block';
            extractionText.innerText = result.data.extraction;
            
            logicDisplay.style.display = 'block';
            logicText.innerText = result.data.analysis;

            // ì‚¬ìš©ì í¸ì˜ë¥¼ ìœ„í•´ ìˆ˜ì •í•  ìˆ˜ ìˆë„ë¡ textareaì—ë„ ê¸°ë³¸ê°’ ì±„ì›Œì£¼ê¸° (ì„ íƒì‚¬í•­)
            // document.getElementById('readingStrategy').value = result.data.extraction;
            // document.getElementById('logicRule').value = result.data.analysis;

            log("âœ… ë¶„ì„ ì™„ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.");
            
            // ë²„íŠ¼ ì „í™˜
            analyzeBtn.style.display = 'none';
            saveBtn.style.display = 'block';

        } catch (e) {
            log(`âŒ ë¶„ì„ ì—ëŸ¬: ${e.message}`, 'error');
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Step 1. ë¬¸ì„œ ë¶„ì„ ì‹¤í–‰";
        }
    }

    // [Step 2] ìµœì¢… ì €ì¥ í•¨ìˆ˜
    async function saveKnowledge() {
        saveBtn.disabled = true;
        saveBtn.innerText = "ì €ì¥ ì¤‘...";

        try {
            const readingStrategy = document.getElementById('readingStrategy').value;
            const logicRule = document.getElementById('logicRule').value;
            const extractionVal = document.getElementById('extractionText').innerText;
            const analysisVal = document.getElementById('logicText').innerText;
            const docType = document.getElementById('docType').value;

            // í”¼ë“œë°±ì´ ì—†ë‹¤ë©´ ê¸°ë³¸ AI ê²°ê³¼ë¼ë„ ì €ì¥í•˜ë„ë¡ ì²˜ë¦¬
            const finalFeedback = `
            [Reading Instruction]: ${readingStrategy || "AI ì¶”ì¶œ ê²°ê³¼ ìŠ¹ì¸"}
            [Logic Instruction]: ${logicRule || "AI ë¶„ì„ ê²°ê³¼ ìŠ¹ì¸"}
            `;

            log("ğŸ’¾ Pinecone DBì— ê²€ì¦ëœ ë°ì´í„° ì €ì¥ ì¤‘...");

            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'save', // ì €ì¥ ëª¨ë“œ
                    docType: docType,
                    fileName: selectedFile.name,
                    extraction: extractionVal, // ì›ë³¸(í˜¹ì€ ìˆ˜ì •ëœ) ì¶”ì¶œê°’
                    analysis: analysisVal,     // ì›ë³¸(í˜¹ì€ ìˆ˜ì •ëœ) ë¶„ì„ê°’
                    userFeedback: finalFeedback // ì‚¬ìš©ìê°€ ì…ë ¥í•œ êµì • ë‚´ìš©
                })
            });

            const result = await response.json();
            if(!result.success) throw new Error(result.error);

            log(`ğŸ‰ ì €ì¥ ì™„ë£Œ! (ID: ${result.upsertId})`);
            alert("í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            
            // ì´ˆê¸°í™”
            resetUI();
            selectedFile = null;
            document.getElementById('fileInput').value = "";
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('readingStrategy').value = "";
            document.getElementById('logicRule').value = "";

        } catch (e) {
            log(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerText = "Step 2. êµì • ë‚´ìš© ì €ì¥";
        }
    }
</script>
</body>
</html>