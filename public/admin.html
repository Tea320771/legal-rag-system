<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë²•ë¥  ë¬¸ì„œ í•™ìŠµ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 40px; background: #f3f4f6; color: #1f2937; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        h1 { margin-top: 0; color: #111827; font-size: 1.5rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 15px; }
        
        .section { margin-bottom: 30px; }
        .label { display: block; font-weight: bold; margin-bottom: 8px; color: #374151; font-size: 1.1rem; }
        .sub-label { display: block; font-size: 0.9rem; color: #6b7280; margin-bottom: 8px; }
        
        .drop-zone { border: 2px dashed #cbd5e1; padding: 30px; text-align: center; cursor: pointer; border-radius: 8px; transition: 0.2s; background: #f9fafb; }
        .drop-zone:hover, .drop-zone.dragover { border-color: #3b82f6; background: #eff6ff; }
        
        .ai-result-box { padding: 15px; margin-bottom: 10px; border-radius: 6px; display: none; border-left-width: 5px; border-left-style: solid; }
        .ai-title { font-weight: bold; margin-bottom: 5px; display: block; font-size: 0.95rem;}
        .ai-content { white-space: pre-wrap; font-size: 0.9rem; color: #334155; font-family: monospace; }

        .box-blue { background-color: #f0f9ff; border-left-color: #0ea5e9; }
        .box-gray { background-color: #f1f5f9; border-left-color: #64748b; }
        .box-purple { background-color: #f5f3ff; border-left-color: #8b5cf6; }
        
        select { padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin-bottom: 10px; font-size: 1rem; }
        textarea { width: 100%; height: 100px; padding: 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.95rem; resize: vertical; margin-bottom: 5px; font-family: monospace;}
        textarea:focus { outline: none; border-color: #2563eb; ring: 2px solid #bfdbfe; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; transition: background 0.2s; color: white; }
        
        #analyzeBtn { background: #4f46e5; }
        #saveBtn { background: #059669; display: none; }
        .btn:disabled { background: #94a3b8; cursor: not-allowed; }

        #status-log { margin-top: 20px; padding: 15px; background: #1e293b; color: #4ade80; font-family: monospace; border-radius: 6px; height: 150px; overflow-y: auto; display: none; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘¨â€ğŸ« AI ë²•ë¥  ë¬¸ì„œ íŠ¸ë ˆì´ë„ˆ (RAG Debugger)</h1>
    <p style="color:#4b5563; margin-bottom:30px;">ê·œì¹™ë§Œ ì ìš©í–ˆì„ ë•Œì™€ RAG DBë¥¼ ì ìš©í–ˆì„ ë•Œë¥¼ ë¹„êµí•˜ì—¬ ìµœì ì˜ ì§€ì‹ì„ í•™ìŠµì‹œí‚µë‹ˆë‹¤.</p>

    <div style="margin-bottom: 20px;">
        <span class="label">ë¬¸ì„œ ì¢…ë¥˜ ì„ íƒ</span>
        <select id="docType">
            <option value="default">ê¸°ë³¸ ë¬¸ì„œ</option>
            <option value="judgment">íŒê²°ë¬¸</option>
            <option value="contract">ì‚¬ê±´ìœ„ì„ê³„ì•½ì„œ</option>
            <option value="receipt">ì˜ìˆ˜ì¦/ì²­êµ¬ì„œ</option>
            <option value="transfer">ì´ì²´ë‚´ì—­</option>
            <option value="powerofattorney">ì‚¬ê±´ìœ„ì„ì¥</option>
        </select>
    </div>

    <div class="section">
        <span class="label">Step 1. í•™ìŠµí•  ë¬¸ì„œ ì—…ë¡œë“œ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)</span>
        <div class="drop-zone" id="dropZone">
            <p>ğŸ“„ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ì´ê³³ìœ¼ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”. (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)</p>
            <input type="file" id="fileInput" style="display: none;" accept=".pdf, .png, .jpg, .jpeg" multiple>
        </div>
        <div id="file-info" style="margin-top:10px; font-weight:bold; color:#2563eb; display:none;"></div>
    </div>

    <div class="section">
        <span class="label">Step 2. ğŸ” ì½ëŠ” ë°©ë²• í™•ì¸ (Extraction)</span>
        <div id="extractionDisplay" class="ai-result-box box-blue">
            <span class="ai-title" style="color:#0284c7;">ğŸ¤– AI Extraction ê²°ê³¼</span>
            <div id="extractionText" class="ai-content"></div>
        </div>
        <textarea id="readingStrategy" placeholder="í…ìŠ¤íŠ¸ ì¶”ì¶œì´ ì˜ëª»ë˜ì—ˆë‹¤ë©´ ìˆ˜ì •í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="section">
        <span class="label">Step 3. ğŸ§  í•´ì„ ë…¼ë¦¬ ë¹„êµ (Logic Comparison)</span>
        <span class="sub-label">ë‘ ê°€ì§€ ê²°ê³¼ë¥¼ ë¹„êµí•˜ì—¬ RAG DBê°€ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</span>

        <div id="logicBaselineDisplay" class="ai-result-box box-gray">
            <span class="ai-title" style="color:#475569;">ğŸ§© [Baseline] GitHub ê·œì¹™ë§Œ ì ìš©í•œ ê²°ê³¼</span>
            <div id="logicBaselineText" class="ai-content"></div>
        </div>

        <div id="logicRAGDisplay" class="ai-result-box box-purple">
            <span class="ai-title" style="color:#7c3aed;">ğŸ”® [RAG Enhanced] GitHub ê·œì¹™ + DB ê³¼ê±°ì‚¬ë¡€ ì ìš© ê²°ê³¼</span>
            <div id="logicRAGText" class="ai-content"></div>
        </div>

        <span class="sub-label" style="margin-top:10px;">ğŸ‘‡ ìµœì¢…ì ìœ¼ë¡œ í•™ìŠµì‹œí‚¬ ë‚´ìš©ì„ ì•„ë˜ì— ì •ë¦¬í•´ì£¼ì„¸ìš”.</span>
        <textarea id="logicRule" placeholder="AIê°€ ë‚˜ì¤‘ì— ì°¸ê³ í•´ì•¼ í•  ì˜¬ë°”ë¥¸ í•´ì„ ë…¼ë¦¬ë¥¼ ìµœì¢… ì‘ì„±í•´ì£¼ì„¸ìš”."></textarea>
    </div>

    <div class="btn-group">
        <button id="analyzeBtn" class="btn" onclick="analyzeDocument()">Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰ (Baseline vs RAG)</button>
        <button id="saveBtn" class="btn" onclick="saveKnowledge()">Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥</button>
    </div>

    <div id="status-log"></div>
</div>

<script>
    let selectedFiles = []; // [ìˆ˜ì •] ë°°ì—´ë¡œ ë³€ê²½
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logDiv = document.getElementById('status-log');

    // Display Elements
    const extractionDisplay = document.getElementById('extractionDisplay');
    const extractionText = document.getElementById('extractionText');
    const logicBaselineDisplay = document.getElementById('logicBaselineDisplay');
    const logicBaselineText = document.getElementById('logicBaselineText');
    const logicRAGDisplay = document.getElementById('logicRAGDisplay');
    const logicRAGText = document.getElementById('logicRAGText');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const saveBtn = document.getElementById('saveBtn');

    // Drag & Drop
    dropZone.onclick = () => fileInput.click();
    dropZone.ondragover = (e) => { e.preventDefault(); dropZone.classList.add('dragover'); };
    dropZone.ondragleave = () => dropZone.classList.remove('dragover');
    dropZone.ondrop = (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    };
    fileInput.onchange = (e) => handleFiles(e.target.files);

    // [ìˆ˜ì •] íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜
    function handleFiles(files) {
        if (!files || files.length === 0) return;
        selectedFiles = Array.from(files); // FileList -> Array ë³€í™˜
        
        const fileNames = selectedFiles.map(f => f.name).join(", ");
        document.getElementById('file-info').style.display = 'block';
        document.getElementById('file-info').innerText = `ì„ íƒëœ íŒŒì¼ (${selectedFiles.length}ê°œ): ${fileNames}`;
        resetUI();
    }

    function resetUI() {
        extractionDisplay.style.display = 'none';
        logicBaselineDisplay.style.display = 'none';
        logicRAGDisplay.style.display = 'none';
        
        saveBtn.style.display = 'none';
        analyzeBtn.style.display = 'block';
        analyzeBtn.disabled = false;
        logDiv.style.display = 'none';
    }

    function log(msg, type='info') {
        logDiv.style.display = 'block';
        const color = type === 'error' ? '#f87171' : '#4ade80';
        logDiv.innerHTML += `<div style="color:${color}; margin-bottom:5px;">> ${msg}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function formatAIOutput(data) {
        if (typeof data === 'object' && data !== null) {
            return JSON.stringify(data, null, 2);
        }
        return data;
    }

    function fileToBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });
    }

    // [Step 1] ë¶„ì„ ìš”ì²­ (ë‹¤ì¤‘ íŒŒì¼)
    async function analyzeDocument() {
        if (selectedFiles.length === 0) { alert("íŒŒì¼ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”."); return; }
        
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = "GitHub ê·œì¹™ ë° DB ê²€ìƒ‰ ì¤‘...";
        logDiv.innerHTML = "";
        
        try {
            const docType = document.getElementById('docType').value;

            // [ìˆ˜ì •] ëª¨ë“  íŒŒì¼ì„ Base64ë¡œ ë³€í™˜í•˜ì—¬ ë°°ì—´ë¡œ ë§Œë“¦
            const filesPayload = await Promise.all(selectedFiles.map(async (file) => {
                const base64 = await fileToBase64(file);
                return {
                    fileBase64: base64,
                    mimeType: file.type,
                    fileName: file.name
                };
            }));

            log(`ğŸš€ íŒŒì¼ ${selectedFiles.length}ê°œ ë¶„ì„ ìš”ì²­ ì¤‘...`);
            
            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'analyze',
                    files: filesPayload, // [ì¤‘ìš”] ë°°ì—´ ì „ì†¡
                    docType: docType
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            // ê²°ê³¼ í‘œì‹œ
            extractionDisplay.style.display = 'block';
            extractionText.innerText = formatAIOutput(result.data.extraction);
            
            logicBaselineDisplay.style.display = 'block';
            logicBaselineText.innerText = formatAIOutput(result.data.analysis_baseline);

            logicRAGDisplay.style.display = 'block';
            logicRAGText.innerText = formatAIOutput(result.data.analysis_rag);

            log("âœ… ë¹„êµ ë¶„ì„ ì™„ë£Œ! ë‘ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ìµœì¢… í•™ìŠµ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”.");
            
            analyzeBtn.style.display = 'none';
            saveBtn.style.display = 'block';

        } catch (e) {
            log(`âŒ ì—ëŸ¬ ë°œìƒ: ${e.message}`, 'error');
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Step 1. ë¹„êµ ë¶„ì„ ì‹¤í–‰";
        }
    }

    // [Step 2] ì €ì¥
    async function saveKnowledge() {
        saveBtn.disabled = true;
        saveBtn.innerText = "ì €ì¥ ì¤‘...";

        try {
            const readingStrategy = document.getElementById('readingStrategy').value;
            const logicRule = document.getElementById('logicRule').value;
            
            const extractionVal = document.getElementById('extractionText').innerText;
            const analysisRAGVal = document.getElementById('logicRAGText').innerText;
            const docType = document.getElementById('docType').value;

            const finalFeedback = `
            [Reading Instruction]: ${readingStrategy || "AI ì¶”ì¶œ ê²°ê³¼ ìŠ¹ì¸"}
            [Logic Instruction]: ${logicRule || "AI RAG ë¶„ì„ ê²°ê³¼ ìŠ¹ì¸"}
            `;

            log("ğŸ’¾ ê²€ì¦ëœ ë°ì´í„° ì €ì¥ ì¤‘...");

            // [ìˆ˜ì •] íŒŒì¼ ì •ë³´ë¥¼ ë‹¤ì‹œ ì „ì†¡ (íŒŒì¼ëª… ì €ì¥ì„ ìœ„í•´)
            const filesPayload = selectedFiles.map(f => ({ fileName: f.name }));

            const response = await fetch('/api/rag-train', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    step: 'save',
                    docType: docType,
                    files: filesPayload, // íŒŒì¼ ì •ë³´(ì´ë¦„) ì „ì†¡
                    extraction: extractionVal,
                    analysis: logicRule ? logicRule : analysisRAGVal,
                    userFeedback: finalFeedback
                })
            });

            const result = await response.json();
            if(!result.success) throw new Error(result.error);

            log(`ğŸ‰ ì €ì¥ ì™„ë£Œ! (ID: ${result.upsertId})`);
            alert("í•™ìŠµ ì™„ë£Œ!");
            
            resetUI();
            selectedFiles = [];
            document.getElementById('fileInput').value = "";
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('readingStrategy').value = "";
            document.getElementById('logicRule').value = "";

        } catch (e) {
            log(`âŒ ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            saveBtn.disabled = false;
            saveBtn.innerText = "Step 2. ìµœì¢… êµì • ë‚´ìš© ì €ì¥";
        }
    }
</script>
</body>
</html>